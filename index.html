<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LèSën Slideshow</title>

<!-- ===== Google Analytics 4 ===== -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TB8FEJRVXY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TB8FEJRVXY');
</script>

<style>
html, body { margin:0; height:100%; background:#000; overflow:hidden; }
.wrap{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }

/* ===== Cross-fade images ===== */
.slide{
  position:absolute;
  max-width:100vw;
  max-height:100vh;
  object-fit:contain;
  opacity:0;
  transition:opacity 1.2s ease;
}
.slide.show{ opacity:1; }

/* ===== HUD (不變) ===== */
.hud{
  position:fixed; left:12px; right:12px; bottom:12px;
  display:flex; justify-content:space-between; align-items:center; gap:12px;
  color:#fff; font:14px/1.2 system-ui,-apple-system,"PingFang TC","Microsoft JhengHei";
  opacity:.85; z-index:10;
}
.btns{ display:flex; gap:8px; flex-wrap:wrap; }
button, select{
  background:rgba(255,255,255,.14);
  color:#fff;
  border:1px solid rgba(255,255,255,.18);
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
}
input[type="range"]{ width:140px; }
.group{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

/* ===== Overlay + transition ===== */
.overlay{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; z-index:9999;

  opacity:0;
  transform:scale(1.02);
  transition:opacity .8s ease, transform 1s ease;
}
.overlay.show{ opacity:1; transform:scale(1); }

.card{
  padding:28px 32px;
  border-radius:18px;
  text-align:center;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(212,175,55,.28);
  box-shadow:
    0 0 60px rgba(212,175,55,.10),
    inset 0 0 40px rgba(255,255,255,.04);
  max-width:min(92vw,720px);
}

/* ✅ 修正 iOS 會出現「大色塊」：讓字是字、不是區塊 */
.brand{
  display:inline-block;
  font-family:"Playfair Display","Cormorant Garamond","Libre Baskerville","Times New Roman",serif;
  font-size:44px;
  letter-spacing:.16em;
  margin:0 0 10px;
  line-height:1.15;

  background:linear-gradient(135deg,#fff3d6,#d4af37,#f6e6b7);
  -webkit-background-clip:text;
  background-clip:text;
  -webkit-text-fill-color:transparent;
  color:transparent;
}

.date{
  font-family:"Libre Baskerville","Times New Roman",serif;
  font-size:16px;
  letter-spacing:.18em;
  color:#e8dfc8;
  margin:0 0 12px;
}
.hint{
  font-size:14px;
  letter-spacing:.08em;
  color:#eae6d8;
  opacity:.90;
}
.err{
  margin-top:10px;
  font-size:12px;
  line-height:1.35;
  color:#f2d6d6;
  opacity:.95;
  white-space:pre-wrap;
}

/* ===== 五套封面背景 ===== */
.cover-all{
  background:
    radial-gradient(circle at 50% 40%, rgba(255,236,200,.30), rgba(40,55,40,.55) 55%, rgba(8,10,8,.95) 100%),
    linear-gradient(180deg,#1a2218 0%,#0b0d0a 100%);
}
.cover-china{
  background:
    radial-gradient(circle at 50% 40%, rgba(180,50,40,.35), rgba(70,20,20,.65) 55%, rgba(15,8,8,.95) 100%),
    linear-gradient(180deg,#2a1515 0%,#0d0606 100%);
}
.cover-vintage{
  background:
    radial-gradient(circle at 50% 40%, rgba(220,190,150,.30), rgba(90,70,50,.55) 55%, rgba(25,20,15,.95) 100%),
    linear-gradient(180deg,#3a2f22 0%,#15110c 100%);
}
.cover-modern{
  background:
    radial-gradient(circle at 50% 40%, rgba(210,230,220,.32), rgba(70,90,80,.45) 55%, rgba(12,16,14,.95) 100%),
    linear-gradient(180deg,#1f2a25 0%,#0c0f0d 100%);
}
.cover-veil{
  background:
    radial-gradient(circle at 50% 40%, rgba(255,255,255,.45), rgba(210,200,180,.35) 55%, rgba(20,18,15,.95) 100%),
    linear-gradient(180deg,#f2efe8 0%,#15120e 100%);
}

/* ===== 標題字色微調：Veil 更亮、China 更深金 ===== */
.cover-all .brand{ background:linear-gradient(135deg,#fff3d6,#d4af37,#f6e6b7); }
.cover-china .brand{ background:linear-gradient(135deg,#f3d3b0,#b08a3a,#7a531f); }  /* 深金 */
.cover-vintage .brand{ background:linear-gradient(135deg,#f2e1c6,#c8a46c,#9a7b4f); }
.cover-modern .brand{ background:linear-gradient(135deg,#f5f6f3,#d6e2d6,#b8cbbd); }
.cover-veil .brand{ background:linear-gradient(135deg,#ffffff,#f6f0df,#e6d8b8); }   /* 更亮白金 */
</style>
</head>

<body>

<div class="wrap">
  <img id="imgA" class="slide show" alt="slide A">
  <img id="imgB" class="slide" alt="slide B">
</div>

<div class="hud">
  <div class="btns">
    <button id="prev">上一張 ←</button>
    <button id="toggle">暫停</button>
    <button id="next">下一張 →</button>
    <button id="musicToggle">音樂：開</button>
  </div>

  <div class="group">
    <label>套組
      <select id="setSelector">
        <option value="A">All</option>
        <option value="B">China</option>
        <option value="C">90’s</option>
        <option value="D">New</option>
        <option value="E">Veil</option>
      </select>
    </label>

    <span id="counter">- / -</span>

    <label>速度
      <input id="speed" type="range" min="2" max="15" value="3">
    </label>
    <span id="sec">3s</span>

    <label>音量
      <input id="volume" type="range" min="0" max="100" value="35">
    </label>
    <span id="volLabel">35%</span>

    <button id="fs">全螢幕</button>
  </div>
</div>

<div id="overlay" class="overlay cover-all">
  <div class="card">
    <div class="brand" id="coverTitle">LèSën Wedding♥</div>
    <div class="date" id="coverDate">January 10, 2026</div>
    <div class="hint" id="coverHint">點一下播放</div>
    <div class="err" id="coverErr" style="display:none"></div>
  </div>
</div>

<audio id="bgm" preload="auto" loop playsinline></audio>

<script>
function track(event, params={}){
  if (typeof gtag === "function") gtag("event", event, params);
}

const imgA = document.getElementById("imgA");
const imgB = document.getElementById("imgB");
let front = imgA, back = imgB;

const counter = document.getElementById("counter");
const speed = document.getElementById("speed");
const sec = document.getElementById("sec");
const overlay = document.getElementById("overlay");
const bgm = document.getElementById("bgm");
const musicToggle = document.getElementById("musicToggle");
const volume = document.getElementById("volume");
const volLabel = document.getElementById("volLabel");
const setSelector = document.getElementById("setSelector");

const coverTitle = document.getElementById("coverTitle");
const coverDate  = document.getElementById("coverDate");
const coverHint  = document.getElementById("coverHint");
const coverErr   = document.getElementById("coverErr");

let photos = [];
let i = 0;
let timer = null;
let playing = false;
let musicOn = true;

let currentSet = (new URLSearchParams(location.search).get("set") || "A").toUpperCase();
setSelector.value = currentSet;

function setVolume(){
  bgm.volume = volume.value/100;
  volLabel.textContent = volume.value + "%";
}

async function playMusic(){
  try{
    await bgm.play();
    musicOn = true;
    musicToggle.textContent = "音樂：開";
  }catch{
    musicOn = false;
    musicToggle.textContent = "音樂：點我開啟";
  }
}
function stopMusic(){
  bgm.pause();
  musicOn = false;
  musicToggle.textContent = "音樂：關";
}

function stop(){
  if (timer) clearInterval(timer);
  timer = null;
  playing = false;
}
function start(){
  stop();
  playing = true;
  timer = setInterval(()=>next(true), Number(speed.value)*1000);
}

function normalizePhotoList(list){
  // ✅ 允許 photosets 裡寫 "001.jpg" 或 "./photos/001.jpg"
  return list
    .filter(x => typeof x === "string" && x.trim())
    .map(x => {
      const s = x.trim();
      if (s.includes("/")) return s.startsWith("./") ? s : "./" + s;
      return "./photos/" + s;
    });
}

function render(){
  if (!photos.length) {
    counter.textContent = "- / -";
    return;
  }
  back.src = photos[i];
  back.classList.add("show");
  front.classList.remove("show");
  [front, back] = [back, front];
  counter.textContent = `${i+1} / ${photos.length}`;
}

function next(auto=false){
  if (!photos.length) return;
  i = (i + 1) % photos.length;
  render();
  if (auto && i === 0){
    stop();
    showCover(); // 播完回封面
  }
}
function prev(){
  if (!photos.length) return;
  i = (i - 1 + photos.length) % photos.length;
  render();
}

function showCover(errMsg=""){
  overlay.style.display = "flex";
  if (errMsg){
    coverErr.style.display = "block";
    coverErr.textContent = errMsg;
    coverHint.textContent = "請修正後再點擊播放";
  }else{
    coverErr.style.display = "none";
    coverErr.textContent = "";
    coverHint.textContent = "點一下播放";
  }
  overlay.classList.add("show");
}

function hideCover(){
  overlay.classList.remove("show");
  setTimeout(()=>overlay.style.display="none", 600);
}

async function loadSet(set){
  stop();
  stopMusic();

  // 先顯示封面（過場）
  overlay.classList.remove("show");
  overlay.style.display = "flex";

  let cfg;
  try{
    const cfgRes = await fetch(`./config/${set}.json`, {cache:"no-store"});
    if (!cfgRes.ok) throw new Error(`讀不到 config/${set}.json（HTTP ${cfgRes.status}）`);
    cfg = await cfgRes.json();
  }catch(e){
    overlay.className = "overlay cover-all";
    coverTitle.textContent = "LèSën Wedding♥";
    coverDate.textContent = "January 10, 2026";
    photos = [];
    render();
    requestAnimationFrame(()=>showCover(String(e)));
    return;
  }

  // 套用封面風格 + 文字
  const styleName = (cfg.coverStyle || "all").toString();
  overlay.className = `overlay cover-${styleName}`;

  coverTitle.textContent = cfg.coverTitle || "LèSën Wedding♥";
  coverDate.textContent  = cfg.coverDate  || "January 10, 2026";

  // 音樂（你說都 OK）
  bgm.src = (cfg.music || "").startsWith("./") ? cfg.music : "./" + (cfg.music || "");
  speed.value = Number(cfg.speedSec || 3);
  sec.textContent = speed.value + "s";

  // 讀照片清單
  try{
    const pj = cfg.photosJson || "";
    const pjPath = pj.startsWith("./") ? pj : "./" + pj;

    const listRes = await fetch(pjPath, {cache:"no-store"});
    if (!listRes.ok) throw new Error(`讀不到 ${pjPath}（HTTP ${listRes.status}）`);

    const raw = await listRes.json();
    if (!Array.isArray(raw) || raw.length === 0){
      throw new Error(`${pjPath} 內容不是陣列或是空的`);
    }

    photos = normalizePhotoList(raw);
    if (!photos.length){
      throw new Error(`${pjPath} 內容無有效檔名`);
    }

    i = 0;
    render();
    setVolume();

    // 淡入封面
    requestAnimationFrame(()=>showCover());
    track("view_set", { set_id:set, set_name:setSelector.selectedOptions[0].text });

  }catch(e){
    photos = [];
    render();
    requestAnimationFrame(()=>showCover(
      `此套組照片清單載入失敗：\n${String(e)}\n\n請確認：\n1) photosets 檔名是否與 config 一致\n2) JSON 內容是否為 ["001.jpg", ...] 或 ["./photos/001.jpg", ...]`
    ));
  }
}

/* ===== 事件（功能不變） ===== */
overlay.onclick = async ()=>{
  // 若此套組照片沒載到，先不要開始
  if (!photos.length) return;

  hideCover();
  track("start_playback", { set_id: currentSet, set_name: setSelector.selectedOptions[0].text });
  await playMusic();
  start();
};

document.getElementById("next").onclick = ()=>next(false);
document.getElementById("prev").onclick = ()=>prev();
document.getElementById("toggle").onclick = ()=>playing ? stop() : start();

musicToggle.onclick = ()=> musicOn ? stopMusic() : playMusic();
volume.oninput = ()=>{ setVolume(); if(!musicOn) playMusic(); };
speed.oninput = ()=>{ sec.textContent = speed.value+"s"; if(playing) start(); };

setSelector.onchange = async ()=>{
  currentSet = setSelector.value;
  history.replaceState(null,"",`?set=${currentSet}`);
  await loadSet(currentSet);
};

document.getElementById("fs").onclick = async ()=>{
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){}
};

loadSet(currentSet);
</script>

</body>
</html>
