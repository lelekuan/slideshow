<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LèSën Slideshow</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    .wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    img { max-width:100vw; max-height:100vh; object-fit:contain; transition:opacity .35s ease; }

    .hud{
      position:fixed; left:12px; right:12px; bottom:12px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      color:#fff; font:14px/1.2 system-ui,-apple-system,"PingFang TC","Microsoft JhengHei";
      opacity:.85;
      pointer-events:auto;
      transition: opacity .35s ease, transform .35s ease;
      z-index: 10;
    }
    .hud.is-hidden{ opacity:0; transform: translateY(8px); pointer-events:none; }

    .btns { display:flex; gap:8px; flex-wrap:wrap; }
    button{
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }
    input[type="range"]{ width:160px; }
    .group{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    /* 迎賓遮罩（暖金/深綠） */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      text-align:center;
      padding:24px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;

      background:
        radial-gradient(circle at 50% 40%,
          rgba(255, 236, 200, .22),
          rgba(40, 35, 20, .55) 55%,
          rgba(10, 10, 10, .95) 100%),
        linear-gradient(180deg, #1a1f16 0%, #0b0d0a 100%);
    }

    /* 光暈擴散動畫 */
    .overlay::after{
      content:"";
      position: fixed;
      inset: -20%;
      pointer-events:none;
      opacity: 0;
      transform: scale(.92);
      transition: opacity .85s ease, transform 1.05s ease;
      background:
        radial-gradient(circle at 50% 40%,
          rgba(255, 231, 170, .00),
          rgba(255, 231, 170, .00) 35%,
          rgba(255, 231, 170, .00) 60%,
          rgba(255, 231, 170, .00) 100%);
    }
    .overlay.is-starting::after{
      opacity: 1;
      transform: scale(1.02);
      background:
        radial-gradient(circle at 50% 40%,
          rgba(255, 231, 170, .22),
          rgba(255, 231, 170, .12) 35%,
          rgba(255, 231, 170, .04) 60%,
          rgba(255, 231, 170, .00) 100%);
    }

    .card{
      position: relative;
      max-width: 720px;
      padding: 28px 30px;
      border-radius: 18px;

      background: rgba(255,255,255,.06);
      border: 1px solid rgba(212, 175, 55, .35);
      box-shadow:
        0 0 60px rgba(212,175,55,.12),
        inset 0 0 40px rgba(255,255,255,.05);

      transform: translateY(0) scale(1);
      opacity: 1;
      transition: opacity .65s ease, transform .65s ease;
      backdrop-filter: blur(8px);
    }
    .card::before{
      content:"";
      position:absolute;
      inset:6px;
      border:1px solid rgba(212,175,55,.18);
      border-radius:12px;
      pointer-events:none;
    }
    .overlay.is-starting .card{
      opacity: 0;
      transform: translateY(6px) scale(.985);
    }

    .brand{
      font-family: "Playfair Display","Cormorant Garamond","Libre Baskerville","Times New Roman",serif;
      font-size: 48px;
      letter-spacing: .16em;
      margin: 0 0 10px;
    }
    .brand.gold{
      background: linear-gradient(135deg,
        #fff3d6 0%,
        #f2d28a 22%,
        #d4af37 48%,
        #f6e6b7 72%,
        #caa13a 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow:
        0 0 18px rgba(212,175,55,.12),
        0 0 1px rgba(255,255,255,.10);
    }
    .hint{
      font-size: 14px;
      opacity: .88;
      margin: 0;
      color: #eae6d8;
      letter-spacing: .08em;
    }
  </style>
</head>
<body>

  <div class="wrap">
    <img id="img" alt="slideshow">
  </div>

  <div class="hud">
    <div class="btns">
      <button id="prev">上一張 ←</button>
      <button id="toggle">暫停</button>
      <button id="next">下一張 →</button>
      <button id="musicToggle">音樂：開</button>
    </div>

    <div class="group">
      <span id="counter">- / -</span>

      <label>
        速度
        <input id="speed" type="range" min="2" max="15" value="3">
      </label>
      <span id="sec">3s</span>

      <label>
        音量
        <input id="volume" type="range" min="0" max="100" value="35">
      </label>
      <span id="volLabel">35%</span>

      <button id="fs">全螢幕 (F)</button>
    </div>
  </div>

  <!-- 迎賓遮罩：中文 -->
  <div id="overlay" class="overlay" role="button" aria-label="tap to start">
    <div class="card">
      <p class="brand gold">LèSën</p>
      <p class="hint">點一下播放</p>
    </div>
  </div>

  <!-- 背景音樂（必須存在：audio/bgm.mp3） -->
  <audio id="bgm" src="./audio/bgm.mp3" preload="auto" loop playsinline></audio>

  <script>
    /* =========================
       基本狀態
    ========================= */
    const img = document.getElementById("img");
    const counter = document.getElementById("counter");
    const speed = document.getElementById("speed");
    const sec = document.getElementById("sec");
    const toggleBtn = document.getElementById("toggle");
    const hud = document.querySelector(".hud");

    let photos = [];
    let i = 0;
    let timer = null;
    let playing = false; // 迎賓模式：未開始前不播放

    /* =========================
       HUD 自動隱藏（5 秒）
    ========================= */
    let hudHideTimer = null;
    function showHudTemporarily() {
      if (!hud) return;
      hud.classList.remove("is-hidden");
      if (hudHideTimer) clearTimeout(hudHideTimer);
      hudHideTimer = setTimeout(() => hud.classList.add("is-hidden"), 5000);
    }
    window.addEventListener("mousemove", showHudTemporarily);
    window.addEventListener("touchstart", showHudTemporarily, { passive: true });

    /* =========================
       音樂（iPhone：必須在點擊事件內 play）
    ========================= */
    const bgm = document.getElementById("bgm");
    const musicToggleBtn = document.getElementById("musicToggle");
    const volume = document.getElementById("volume");
    const volLabel = document.getElementById("volLabel");
    let musicOn = true;

    function setVolumeFromUI() {
      const v = Number(volume.value) / 100;
      bgm.volume = Math.min(1, Math.max(0, v));
      volLabel.textContent = `${volume.value}%`;
    }
    setVolumeFromUI();

    async function enableMusic() {
      try {
        // iOS 上建議先設定 currentTime 再 play（避免某些情況卡住）
        if (bgm.currentTime > 0 && bgm.paused) {
          // do nothing
        }
        await bgm.play();
        musicOn = true;
        musicToggleBtn.textContent = "音樂：開";
      } catch (e) {
        // 若被擋，按鈕會提示再點一次
        musicOn = false;
        musicToggleBtn.textContent = "音樂：點我開啟";
      }
    }

    function disableMusic() {
      bgm.pause();
      musicOn = false;
      musicToggleBtn.textContent = "音樂：關";
    }

    musicToggleBtn.onclick = async () => {
      showHudTemporarily();
      if (musicOn) disableMusic();
      else await enableMusic();
    };

    volume.oninput = async () => {
      showHudTemporarily();
      setVolumeFromUI();
      if (!musicOn) await enableMusic();
    };

    /* =========================
       預載快取
    ========================= */
    const preloadCache = new Map();
    const PRELOAD_LIMIT = 12;

    function preload(idx) {
      if (!photos.length) return;
      const j = (idx + photos.length) % photos.length;
      const url = photos[j];
      if (preloadCache.has(url)) return;

      const im = new Image();
      im.decoding = "async";
      im.loading = "eager";
      im.src = url;

      preloadCache.set(url, im);
      if (preloadCache.size > PRELOAD_LIMIT) {
        const firstKey = preloadCache.keys().next().value;
        preloadCache.delete(firstKey);
      }
    }

    /* =========================
       輪播核心
    ========================= */
    function intervalMs() { return Number(speed.value) * 1000; }
    function updateSpeedLabel() { sec.textContent = `${speed.value}s`; }

    function render() {
      img.style.opacity = 0;
      setTimeout(() => {
        img.src = photos[i];
        counter.textContent = `${i + 1} / ${photos.length}`;
        img.onload = () => { img.style.opacity = 1; };
        preload(i + 1);
        preload(i + 2);
      }, 120);
    }

    function next() { i = (i + 1) % photos.length; render(); }
    function prev() { i = (i - 1 + photos.length) % photos.length; render(); }

    function start() {
      stop();
      timer = setInterval(next, intervalMs());
      playing = true;
      toggleBtn.textContent = "暫停";
    }

    function stop() {
      if (timer) clearInterval(timer);
      timer = null;
      playing = false;
      toggleBtn.textContent = "播放";
    }

    /* =========================
       全螢幕（可嘗試；iOS 可能不支援整頁 fullscreen）
    ========================= */
    async function tryFullscreen() {
      try {
        if (!document.fullscreenElement) {
          await document.documentElement.requestFullscreen();
        }
      } catch (e) { /* ignore */ }
    }

    document.getElementById("fs").onclick = async () => {
      showHudTemporarily();
      try {
        if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      } catch (e) {}
    };

    /* =========================
       控制事件
    ========================= */
    document.getElementById("next").onclick = () => { showHudTemporarily(); next(); if (playing) start(); };
    document.getElementById("prev").onclick = () => { showHudTemporarily(); prev(); if (playing) start(); };
    toggleBtn.onclick = () => { showHudTemporarily(); playing ? stop() : start(); };

    speed.oninput = () => {
      showHudTemporarily();
      updateSpeedLabel();
      if (playing) start();
    };

    window.addEventListener("keydown", (e) => {
      showHudTemporarily();
      if (e.key === "ArrowRight") { next(); if (playing) start(); }
      if (e.key === "ArrowLeft")  { prev(); if (playing) start(); }
      if (e.key === " ") { e.preventDefault(); playing ? stop() : start(); }
      if (e.key.toLowerCase() === "f") document.getElementById("fs").click();
      if (e.key.toLowerCase() === "m") musicToggleBtn.click();
    });

    /* =========================
       迎賓：點一下開始（同時：動畫 + 音樂 + 輪播）
    ========================= */
    const overlay = document.getElementById("overlay");

    async function beginExperience() {
      overlay.classList.add("is-starting");
      setTimeout(() => { overlay.style.display = "none"; }, 650);

      // 避免黑屏
      render();
      preload(i + 1);
      preload(i + 2);

      // 關鍵：音樂播放必須在這個 click/touch 事件內呼叫
      await tryFullscreen();
      await enableMusic();
      start();

      showHudTemporarily();
    }

    overlay.addEventListener("click", beginExperience);
    overlay.addEventListener("touchend", (e) => {
      e.preventDefault();
      beginExperience();
    }, { passive: false });

    /* =========================
       初始化
    ========================= */
    async function init() {
      updateSpeedLabel();

      const res = await fetch("./photos.json", { cache: "no-store" });
      photos = await res.json();

      if (!Array.isArray(photos) || photos.length === 0) {
        document.body.innerHTML = "<p style='color:white'>photos.json 沒有照片</p>";
        return;
      }

      // 背景先顯示第一張，但不自動播放（等點一下）
      render();
      preload(i + 1);
      preload(i + 2);
      stop();

      // 預設顯示 HUD（之後 5 秒自動隱藏）
      if (hud) hud.classList.remove("is-hidden");
      showHudTemporarily();
    }

    init().catch(err => {
      document.body.innerHTML = `<p style="color:white">載入失敗：${err}</p>`;
    });
  </script>

</body>
</html>
