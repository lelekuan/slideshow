<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LèSën Slideshow</title>

  <!-- ===== Google Analytics 4 ===== -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CJ1LT82YGQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CJ1LT82YGQ');
  </script>

  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    .wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    img { max-width:100vw; max-height:100vh; object-fit:contain; transition:opacity .35s ease; }

    .hud{
      position:fixed; left:12px; right:12px; bottom:12px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      color:#fff; font:14px/1.2 system-ui,-apple-system,"PingFang TC","Microsoft JhengHei";
      opacity:.85;
      transition: opacity .35s ease, transform .35s ease;
      z-index:10;
    }
    .hud.is-hidden{ opacity:0; transform:translateY(8px); pointer-events:none; }

    .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    button, select{
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }
    input[type="range"]{ width:140px; }
    .group{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:9999; cursor:pointer;
      background:
        radial-gradient(circle at 50% 40%,
          rgba(255,236,200,.22),
          rgba(40,35,20,.55) 55%,
          rgba(10,10,10,.95) 100%),
        linear-gradient(180deg,#1a1f16 0%,#0b0d0a 100%);
    }

    .card{
      padding:30px 36px;
      border-radius:18px;
      text-align:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(212,175,55,.35);
      box-shadow:
        0 0 60px rgba(212,175,55,.12),
        inset 0 0 40px rgba(255,255,255,.05);
    }

    .brand{
      font-family:"Playfair Display","Times New Roman",serif;
      font-size:48px; letter-spacing:.16em;
      background:linear-gradient(135deg,#fff3d6,#d4af37,#f6e6b7);
      -webkit-background-clip:text; color:transparent;
      margin:0 0 8px;
    }
    .date{ color:#e8dfc8; letter-spacing:.18em; margin-bottom:12px; }
    .hint{ color:#eae6d8; opacity:.85; font-size:14px; }
  </style>
</head>

<body>

<div class="wrap"><img id="img"></div>

<div class="hud">
  <div class="btns">
    <button id="prev">上一張 ←</button>
    <button id="toggle">暫停</button>
    <button id="next">下一張 →</button>
    <button id="musicToggle">音樂：開</button>
  </div>

  <div class="group">
    <label>
      套組
      <select id="setSelector">
        <option value="A">All</option>
        <option value="B">China</option>
        <option value="C">90’s</option>
        <option value="D">New</option>
        <option value="E">Veil</option>
      </select>
    </label>

    <span id="counter">- / -</span>

    <label>速度
      <input id="speed" type="range" min="2" max="15" value="3">
    </label>
    <span id="sec">3s</span>

    <label>音量
      <input id="volume" type="range" min="0" max="100" value="35">
    </label>
    <span id="volLabel">35%</span>

    <button id="fs">全螢幕</button>
  </div>
</div>

<div id="overlay" class="overlay">
  <div class="card">
    <p class="brand" id="coverTitle">LèSën Wedding♥</p>
    <p class="date" id="coverDate">January 10, 2026</p>
    <p class="hint">點一下播放</p>
  </div>
</div>

<audio id="bgm" preload="auto" loop playsinline></audio>

<script>
/* ===== GA helper ===== */
function track(event, params={}){
  if (typeof gtag === "function") {
    gtag("event", event, params);
  }
}

/* ===== 基本變數 ===== */
const setSelector = document.getElementById("setSelector");
const img = document.getElementById("img");
const counter = document.getElementById("counter");
const speed = document.getElementById("speed");
const sec = document.getElementById("sec");
const toggleBtn = document.getElementById("toggle");
const overlay = document.getElementById("overlay");
const bgm = document.getElementById("bgm");
const musicToggle = document.getElementById("musicToggle");
const volume = document.getElementById("volume");
const volLabel = document.getElementById("volLabel");

let photos=[], i=0, timer=null, playing=false, musicOn=true;
let currentSet = (new URLSearchParams(location.search).get("set") || "A").toUpperCase();
setSelector.value = currentSet;

/* ===== 功能 ===== */
function setVolume(){
  bgm.volume = volume.value/100;
  volLabel.textContent = volume.value+"%";
}
async function playMusic(){
  try{ await bgm.play(); musicOn=true; musicToggle.textContent="音樂：開"; }
  catch{ musicOn=false; musicToggle.textContent="音樂：點我開啟"; }
}
function stopMusic(){
  bgm.pause(); musicOn=false; musicToggle.textContent="音樂：關";
}
function stop(){
  if(timer) clearInterval(timer);
  timer=null; playing=false; toggleBtn.textContent="播放";
}
function render(){
  img.style.opacity=0;
  setTimeout(()=>{
    img.src = photos[i];
    counter.textContent = `${i+1} / ${photos.length}`;
    img.onload=()=>img.style.opacity=1;
  },120);
}
function next(auto=false){
  i=(i+1)%photos.length; render();
  if(auto && i===0){ stop(); overlay.style.display="flex"; }
}
function prev(){ i=(i-1+photos.length)%photos.length; render(); }
function start(){
  stop(); playing=true; toggleBtn.textContent="暫停";
  timer=setInterval(()=>next(true), Number(speed.value)*1000);
}

/* ===== 載入套組 ===== */
async function loadSet(set){
  stop(); stopMusic();
  const cfg = await fetch(`./config/${set}.json`,{cache:"no-store"}).then(r=>r.json());
  document.getElementById("coverTitle").textContent = cfg.coverTitle;
  document.getElementById("coverDate").textContent = cfg.coverDate;
  bgm.src = cfg.music;
  speed.value = cfg.speedSec;
  sec.textContent = cfg.speedSec+"s";
  photos = await fetch(cfg.photosJson,{cache:"no-store"}).then(r=>r.json());
  i=0; render(); setVolume();
  overlay.style.display="flex";

  /* === GA：此套組被打開一次 === */
  track("view_set", { set_id:set, set_name:setSelector.selectedOptions[0].text });
}

/* ===== 事件 ===== */
overlay.onclick = async ()=>{
  overlay.style.display="none";
  track("start_playback", {
    set_id: currentSet,
    set_name: setSelector.selectedOptions[0].text
  });
  await playMusic(); start();
};
toggleBtn.onclick = ()=> playing?stop():start();
document.getElementById("next").onclick = ()=>next(false);
document.getElementById("prev").onclick = ()=>prev();
musicToggle.onclick = async ()=> musicOn?stopMusic():await playMusic();
volume.oninput = ()=>{ setVolume(); if(!musicOn) playMusic(); };
speed.oninput = ()=>{ sec.textContent=speed.value+"s"; if(playing) start(); };
document.getElementById("fs").onclick = async ()=>{
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){}
};
setSelector.onchange = async ()=>{
  currentSet=setSelector.value;
  history.replaceState(null,"",`?set=${currentSet}`);
  await loadSet(currentSet);
};

/* ===== 初始化 ===== */
loadSet(currentSet);
</script>

</body>
</html>
